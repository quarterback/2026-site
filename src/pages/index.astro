---
import { supabase } from '../lib/supabase';
import Base from '../layouts/Base.astro';
import Hero from '../components/Hero.astro';
import WorkCard from '../components/WorkCard.astro';
import MediaShowcase from '../components/MediaShowcase.astro';
import About from '../components/About.astro';
import Contact from '../components/Contact.astro';
import Writing from '../components/Writing.astro';
import Footer from '../components/Footer.astro';
import NowPlaying from '../components/NowPlaying.astro';

const { data: workData } = await supabase
  .from('work_items')
  .select('*')
  .eq('published', true)
  .order('display_order', { ascending: true });

const work = workData || [];
const featuredWork = work[0];

const { data: mediaData } = await supabase
  .from('media_items')
  .select('*')
  .eq('published', true)
  .order('published_at', { ascending: false });

const media = (mediaData || []).map(item => ({
  title: item.title,
  source: item.description,
  mediaType: item.media_type as 'podcast' | 'talk' | 'article',
  embedUrl: item.embed_url,
  url: item.embed_url,
  date: new Date(item.published_at).getFullYear().toString(),
}));

const socials = [
  { name: "Bluesky", url: "https://bsky.app/profile/ronbronson.com" },
  { name: "LinkedIn", url: "https://linkedin.com/in/ronbronson" },
  { name: "GitHub", url: "https://github.com/ronbronson" },
];

const blogPosts = [
  {
    title: "Example Blog Post",
    url: "https://blog.ronbronson.com/example-post",
    date: new Date("2024-01-15"),
    excerpt: "This is a placeholder for curated blog posts from your Blot blog."
  },
];

const techStack = [
  "Astro",
  "Open Props",
  "TypeScript"
];

const fonts = [
  "Urbanist",
  "Halant"
];
---

<Base title="Ron Bronson — Designer">
  <main>
    <Hero
      name="Ron Bronson"
      tagline="I design how public systems make decisions."
      location="Portland, OR"
    />

    <!-- Featured case study -->
    {featuredWork && (
      <section class="featured">
        <div class="container">
          <p class="label">Featured</p>
          <a href={`/work/${featuredWork.slug}`} class="featured__link">
            <h2>{featuredWork.title}</h2>
            <p>{featuredWork.description}</p>
            <span class="featured__cta">Read case study →</span>
          </a>
        </div>
      </section>
    )}

    <!-- Work grid -->
    <section id="work">
      <div class="container">
        <h2 class="section-heading">Selected Work</h2>
        <div class="work-grid">
          {work.map(item => (
            <WorkCard
              title={item.title}
              summary={item.description}
              systemType={item.client || 'Project'}
              outcome={item.year ? `${item.year}` : undefined}
              href={`/work/${item.slug}`}
              tags={item.tags}
            />
          ))}
        </div>
      </div>
    </section>

    <!-- Media -->
    <section id="media">
      <div class="container">
        <h2 class="section-heading">Media</h2>
        <p class="section-intro">Talks, podcasts, and writing about service design, public-sector delivery, and system consequences.</p>
        <div class="media-showcase-list">
          {media.map(item => (
            <MediaShowcase {...item} />
          ))}
        </div>
      </div>
    </section>

    <!-- About & Now Playing -->
    <section id="about">
      <div class="container">
        <h2 class="section-heading">About</h2>
        <div class="about-grid">
          <div class="about-content">
            <About
              content={`<p>I've spent my career at the intersection of design, policy, and technology—from federal agencies like 18F to universities to civic tech organizations. My work focuses on how public institutions make decisions and serve people at scale.</p>

              <p>I teach, write, and speak about <strong>consequence design</strong>: understanding the downstream effects of design decisions, especially in high-stakes systems where getting it wrong has real human impact.</p>

              <p>Outside of work, I'm a tea sommelier, high school tennis coach, and host a local radio show. I believe the same systems thinking that helps design better public services also helps you steep a perfect cup of tea.</p>`}
            />
          </div>
          <div class="now-playing-sidebar">
            <NowPlaying
              service="lastfm"
              username="ronbronson"
            />
          </div>
        </div>
      </div>
    </section>

    <!-- Writing -->
    <section id="writing">
      <div class="container">
        <Writing posts={blogPosts} />
      </div>
    </section>

    <!-- Contact -->
    <section id="contact">
      <div class="container">
        <Contact
          email="hello@ronbronson.dev"
          socials={socials}
        />
      </div>
    </section>
  </main>

  <Footer
    newsletterUrl="https://makingpublicwork.com"
    techStack={techStack}
    fonts={fonts}
    socials={socials}
  />
</Base>

<style>
  /* Featured section */
  .featured__link {
    display: block;
    text-decoration: none;
  }

  .featured__link h2 {
    font-size: clamp(var(--font-size-2), 3vw, var(--font-size-3));
    color: var(--text-1);
    margin-bottom: var(--size-2);
  }

  .featured__link p {
    font-size: var(--font-size-1);
    color: var(--text-2);
    margin-bottom: var(--size-3);
  }

  .featured__cta {
    font-size: var(--font-size-0);
    color: var(--brand);
    font-weight: var(--font-weight-5);
  }

  .featured__link:hover .featured__cta {
    text-decoration: underline;
  }

  /* Section headings */
  .section-heading {
    font-size: clamp(var(--font-size-2), 4vw, var(--font-size-3));
    margin-bottom: var(--size-4);
  }

  .section-intro {
    color: var(--text-3);
    margin-bottom: var(--size-5);
    font-size: var(--font-size-1);
  }

  @media (max-width: 600px) {
    .section-heading {
      margin-bottom: var(--size-3);
    }

    .section-intro {
      margin-bottom: var(--size-4);
    }
  }

  /* Work grid - 3 columns, denser */
  .work-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--size-4);
  }

  @media (max-width: 900px) {
    .work-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 600px) {
    .work-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Media showcase */
  .media-showcase-list {
    display: flex;
    flex-direction: column;
    gap: var(--size-8);
  }

  /* About grid with now playing */
  .about-grid {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: var(--size-6);
    align-items: start;
  }

  @media (max-width: 1024px) {
    .about-grid {
      grid-template-columns: 1fr;
      gap: var(--size-5);
    }

    .now-playing-sidebar {
      order: -1;
    }
  }

  @media (max-width: 600px) {
    .about-grid {
      gap: var(--size-4);
    }
  }
</style>
