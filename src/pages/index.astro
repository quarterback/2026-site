---
import { getCollection } from 'astro:content';
import Base from '../layouts/Base.astro';
import Hero from '../components/Hero.astro';
import WorkCard from '../components/WorkCard.astro';
import Writing from '../components/Writing.astro';
import Books from '../components/Books.astro';
import NowPlaying from '../components/NowPlaying.astro';
import Music from '../components/Music.astro';
import Contact from '../components/Contact.astro';
import Footer from '../components/Footer.astro';
import { fetchMultipleRSS } from '../lib/rss';

const allWork = await getCollection('work', ({ data }) => !data.draft);
const work = allWork.sort((a, b) => a.data.order - b.data.order);

const rssFeeds = [
  'https://makingpublicwork.com/rss',
  'https://blog.ronbronson.com/rss',
];

let recentPosts: any[] = [];
try {
  const allPosts = await fetchMultipleRSS(rssFeeds);
  recentPosts = allPosts.slice(0, 5);
} catch (error) {
  console.error('Failed to fetch RSS feeds:', error);
  recentPosts = [];
}

const currentBooks = [
  {
    title: "The Power Broker",
    author: "Robert Caro",
    cover: "https://images.pexels.com/photos/1181671/pexels-photo-1181671.jpeg?auto=compress&cs=tinysrgb&w=200",
    status: "reading" as const,
  },
];

const socials = [
  { name: "Bluesky", url: "https://bsky.app/profile/ronbronson.com" },
  { name: "LinkedIn", url: "https://linkedin.com/in/ronbronson" },
  { name: "GitHub", url: "https://github.com/ronbronson" },
];

const techStack = [
  "Astro",
  "Open Props",
  "TypeScript"
];

const fonts = [
  "Urbanist",
  "Halant"
];
---

<Base title="Ron Bronson — Designer">
  <main>
    <Hero
      name="Ron Bronson"
      tagline="I design how public systems make decisions."
    />

    <!-- Now section - flexible content -->
    <section class="now-section">
      <div class="container">
        <p class="label">Currently</p>
        <div class="now-content">
          <h2>What I'm focused on right now</h2>
          <p>Leading product at State Capacity AI, teaching Urban Technology at University of Michigan, and launching Years Ahead in Spring 2026.</p>
        </div>
      </div>
    </section>

    <!-- Music & Media -->
    <section id="music">
      <div class="container">
        <div class="music-grid">
          <div class="music-item">
            <NowPlaying service="lastfm" username="ronbronson" />
          </div>
          <div class="music-item">
            <Music
              title="Radio Show"
              embedUrl="https://www.mixcloud.com/widget/iframe/?hide_cover=1&feed=%2Fronbronson%2F"
              embedType="mixcloud"
            />
          </div>
        </div>
      </div>
    </section>

    <!-- Work grid -->
    <section id="work">
      <div class="container">
        <h2 class="section-heading">Selected Work</h2>
        <div class="work-grid">
          {work.map(item => (
            <WorkCard
              title={item.data.title}
              summary={item.data.summary}
              systemType={item.data.systemType}
              outcome={item.data.outcome}
              href={item.data.externalUrl || `/work/${item.slug}`}
              tags={item.data.tags}
            />
          ))}
        </div>
      </div>
    </section>

    <!-- Writing -->
    {recentPosts.length > 0 && (
      <section id="writing">
        <div class="container">
          <Writing posts={recentPosts} blogUrl="https://makingpublicwork.com" />
        </div>
      </section>
    )}

    <!-- Books -->
    <section id="books">
      <div class="container">
        <Books books={currentBooks} title="Currently Reading" />
      </div>
    </section>

    <!-- About preview -->
    <section id="about-preview">
      <div class="container">
        <h2 class="section-heading">About</h2>
        <p class="about-preview-text">I've spent my career at the intersection of design, policy, and technology—from federal agencies like 18F to universities to civic tech organizations. My work focuses on how public institutions make decisions and serve people at scale.</p>
        <a href="/about" class="section-link">More about me →</a>
      </div>
    </section>

    <!-- Media preview -->
    <section id="media-preview">
      <div class="container">
        <h2 class="section-heading">Recent Talks</h2>
        <p class="media-preview-text">Speaking about service design, public-sector delivery, and system consequences.</p>
        <a href="/media" class="section-link">View all media →</a>
      </div>
    </section>

    <!-- Contact -->
    <section id="contact">
      <div class="container">
        <Contact
          email="hello@ronbronson.dev"
          socials={socials}
        />
      </div>
    </section>
  </main>

  <Footer
    newsletterUrl="https://makingpublicwork.com"
    techStack={techStack}
    fonts={fonts}
    socials={socials}
  />
</Base>

<style>
  /* Now section */
  .now-section {
    margin-bottom: var(--size-8);
  }

  .now-content h2 {
    font-size: clamp(var(--font-size-2), 3vw, var(--font-size-3));
    color: var(--text-1);
    margin-bottom: var(--size-3);
  }

  .now-content p {
    font-size: var(--font-size-1);
    color: var(--text-2);
    max-width: 70ch;
    line-height: 1.6;
  }

  /* Music section */
  #music {
    margin-bottom: var(--size-8);
  }

  .music-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--size-5);
  }

  @media (max-width: 768px) {
    .music-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Section headings */
  .section-heading {
    font-size: clamp(var(--font-size-2), 4vw, var(--font-size-3));
    margin-bottom: var(--size-4);
  }

  .section-intro {
    color: var(--text-3);
    margin-bottom: var(--size-5);
    font-size: var(--font-size-1);
  }

  @media (max-width: 600px) {
    .section-heading {
      margin-bottom: var(--size-3);
    }

    .section-intro {
      margin-bottom: var(--size-4);
    }
  }

  /* Work grid - 3 columns, denser */
  .work-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--size-4);
  }

  @media (max-width: 900px) {
    .work-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 600px) {
    .work-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Preview sections */
  #about-preview,
  #media-preview {
    margin-bottom: var(--size-8);
  }

  .about-preview-text,
  .media-preview-text {
    font-size: var(--font-size-1);
    color: var(--text-2);
    max-width: 70ch;
    line-height: 1.6;
    margin-bottom: var(--size-4);
  }

  .section-link {
    display: inline-flex;
    align-items: center;
    font-size: var(--font-size-1);
    color: var(--brand);
    font-weight: var(--font-weight-5);
    text-decoration: none;
  }

  .section-link:hover {
    text-decoration: underline;
  }
</style>
