---
import { getCollection } from 'astro:content';
import Base from '../../layouts/Base.astro';
import CaseStudyImage from '../../components/CaseStudyImage.astro';
import CaseStudyImagePair from '../../components/CaseStudyImagePair.astro';
import BeforeAfter from '../../components/BeforeAfter.astro';
import Callout from '../../components/Callout.astro';
import QuoteCard from '../../components/QuoteCard.astro';
import InsightsList from '../../components/InsightsList.astro';
import MetricsRow from '../../components/MetricsRow.astro';
import SectionDivider from '../../components/SectionDivider.astro';

export async function getStaticPaths() {
  const work = await getCollection('work', ({ data }) => !data.draft);
  return work.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();
const {
  title,
  type,
  lede,
  hero,
  metadata,
  links = [],
  tags = [],
  toc = false,
} = entry.data;

// Parse metadata - support both array and object formats
let metadataList = [];
if (Array.isArray(metadata)) {
  metadataList = metadata;
} else if (metadata && typeof metadata === 'object') {
  // Convert old object format to array
  const fields = [
    { label: 'Type', value: type },
    { label: 'Role', value: metadata.role },
    { label: 'Duration', value: metadata.duration || metadata.dates },
    { label: 'Location', value: metadata.location },
    { label: 'Team', value: metadata.team },
    { label: 'Scale', value: metadata.scale },
    { label: 'Skills', value: metadata.skills },
    { label: 'Status', value: metadata.status },
  ];
  metadataList = fields.filter(item => item.value);
}

// Generate TOC from H2 headings
const tocItems = toc ? headings.filter(h => h.depth === 2) : [];

// All components for MDX
const components = {
  'astro-image': CaseStudyImage,
  'astro-image-pair': CaseStudyImagePair,
  'astro-before-after': BeforeAfter,
  'astro-callout': Callout,
  'astro-quote': QuoteCard,
  'astro-insights': InsightsList,
  'astro-metrics': MetricsRow,
  'astro-divider': SectionDivider,
};
---

<Base title={`${title} â€” Ron Bronson`}>
  <article class="case-study">
    <!-- TOC Navigation (if enabled) -->
    {toc && tocItems.length > 0 && (
      <nav class="toc-nav" id="toc-nav">
        <button class="toc-toggle" id="toc-toggle">
          <i class="fas fa-bars"></i> Skip to
        </button>
        <div class="toc-menu" id="toc-menu">
          <div class="toc-header">Jump to section</div>
          {tocItems.map(item => (
            <a href={`#${item.slug}`} class="toc-link">
              {item.text}
            </a>
          ))}
        </div>
      </nav>
    )}

    <!-- Hero Block -->
    <header class="case-study__hero">
      <div class="portfolio-container">
        <a href="/#work" class="back-link">&larr; Back to all work</a>

        <div class={`hero-layout ${hero?.image ? 'hero-layout--with-image' : 'hero-layout--simple'}`}>
          {/* Metadata Column (Left) */}
          {metadataList.length > 0 && (
            <aside class="hero-metadata">
              {metadataList.map(item => (
                <div class="metadata-item">
                  <div class="metadata-label">{item.label}</div>
                  <div class="metadata-value">{item.value}</div>
                </div>
              ))}
            </aside>
          )}

          {/* Title + Lede + Image (Right) */}
          <div class="hero-content">
            <h1 class="case-study__title">{title}</h1>
            <p class="case-study__lede">{lede}</p>

            {hero?.image && (
              <div class={`hero-image hero-image--${hero.layout || 'contained'}`}>
                <img src={hero.image} alt={title} loading="eager" />
              </div>
            )}
          </div>
        </div>
      </div>
    </header>

    <!-- Content Body -->
    <div class="case-study__body">
      <div class="portfolio-container">
        <Content {components} />
      </div>
    </div>

    {links.length > 0 && (
      <section class="case-study__links">
        <div class="container container--narrow">
          <h2>Links</h2>
          <ul class="links-list">
            {links.map(link => (
              <li>
                <a href={link.url} target="_blank" rel="noopener noreferrer">
                  {link.label}
                  <i class="fas fa-external-link-alt"></i>
                </a>
              </li>
            ))}
          </ul>
        </div>
      </section>
    )}

    <footer class="case-study__footer portfolio-container">
      <a href="/#work" class="back-link">&larr; Back to all work</a>
    </footer>
  </article>

  <!-- TOC Toggle Script -->
  <script>
    function initTOC() {
      const toggle = document.getElementById('toc-toggle');
      const menu = document.getElementById('toc-menu');

      if (!toggle || !menu) return;

      toggle.addEventListener('click', () => {
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
      });

      // Close when clicking outside
      document.addEventListener('click', (e) => {
        if (!toggle.contains(e.target) && !menu.contains(e.target)) {
          menu.style.display = 'none';
        }
      });
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTOC);
    } else {
      initTOC();
    }
  </script>

  <!-- Parallax scrolling effect -->
  <script>
    function initParallax() {
      const parallaxElements = document.querySelectorAll('[data-parallax]');

      if (parallaxElements.length === 0) return;

      function updateParallax() {
        parallaxElements.forEach((element) => {
          const rect = element.getBoundingClientRect();
          const windowHeight = window.innerHeight;

          // Only apply parallax when element is in viewport
          if (rect.top < windowHeight && rect.bottom > 0) {
            const scrolled = window.pageYOffset || window.scrollY;
            const elementTop = rect.top + scrolled;
            const parallaxValue = (scrolled - elementTop) * 0.3;

            const img = element.querySelector('img');
            if (img) {
              img.style.transform = `translateY(${parallaxValue}px)`;
            }
          }
        });
      }

      // Throttle scroll events for performance
      let ticking = false;
      function onScroll() {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            updateParallax();
            ticking = false;
          });
          ticking = true;
        }
      }

      window.addEventListener('scroll', onScroll, { passive: true });
      updateParallax(); // Initial call
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initParallax);
    } else {
      initParallax();
    }
  </script>
</Base>

<style>
  /* Portfolio container */
  .portfolio-container {
    max-width: 1200px;
    margin: 0 auto;
    padding-left: 24px;
    padding-right: 24px;
  }

  @media (min-width: 1024px) {
    .portfolio-container {
      padding-left: 48px;
      padding-right: 48px;
    }
  }

  /* TOC Navigation */
  .toc-nav {
    position: fixed;
    top: 80px;
    right: 24px;
    z-index: 100;
  }

  .toc-toggle {
    background: var(--surface-2);
    border: 1px solid var(--surface-3);
    padding: var(--size-2) var(--size-4);
    border-radius: var(--radius-2);
    font-size: var(--font-size-0);
    color: var(--text-2);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--size-2);
    font-family: var(--font-mono);
  }

  .toc-toggle:hover {
    border-color: var(--brand);
    color: var(--text-1);
  }

  .toc-menu {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: var(--size-2);
    background: var(--surface-1);
    border: 1px solid var(--surface-3);
    border-radius: var(--radius-2);
    padding: var(--size-3);
    min-width: 200px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    display: none;
  }

  .toc-toggle:focus + .toc-menu,
  .toc-toggle:hover + .toc-menu,
  .toc-menu:hover {
    display: block;
  }

  .toc-header {
    font-size: var(--font-size-00);
    font-weight: var(--font-weight-6);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-3);
    margin-bottom: var(--size-2);
    padding-bottom: var(--size-2);
    border-bottom: 1px solid var(--surface-3);
  }

  .toc-link {
    display: block;
    padding: var(--size-2);
    font-size: var(--font-size-0);
    color: var(--text-2);
    text-decoration: none;
    border-radius: var(--radius-1);
  }

  .toc-link:hover {
    background: var(--surface-2);
    color: var(--text-1);
  }

  @media (max-width: 900px) {
    .toc-nav {
      display: none;
    }
  }

  /* Hero Block Layout */
  .case-study__hero {
    padding-block: clamp(3rem, 8vh, 6rem);
  }

  .back-link {
    display: inline-block;
    font-size: var(--font-size-0);
    color: var(--text-3);
    margin-bottom: var(--size-6);
    text-decoration: none;
  }

  .back-link:hover {
    color: var(--brand);
  }

  /* Hero Layout: Metadata left, Content right */
  .hero-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--size-8);
  }

  .hero-layout--with-image {
    grid-template-columns: 1fr 2fr;
    gap: var(--size-10);
  }

  @media (min-width: 900px) {
    .hero-layout--simple {
      grid-template-columns: 250px 1fr;
      gap: var(--size-10);
    }
  }

  @media (max-width: 900px) {
    .hero-layout {
      grid-template-columns: 1fr !important;
      gap: var(--size-6);
    }

    .hero-metadata {
      order: 2;
    }

    .hero-content {
      order: 1;
    }
  }

  /* Metadata Column (Left) */
  .hero-metadata {
    display: flex;
    flex-direction: column;
    gap: var(--size-5);
  }

  .metadata-item {
    display: flex;
    flex-direction: column;
    gap: var(--size-1);
  }

  .metadata-label {
    font-family: var(--font-mono);
    font-size: var(--font-size-00);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-3);
  }

  .metadata-value {
    font-size: var(--font-size-1);
    color: var(--text-1);
    line-height: 1.4;
  }

  /* Title + Lede (Right) */
  .hero-content {
    display: flex;
    flex-direction: column;
  }

  .case-study__title {
    font-size: clamp(2rem, 5vw, 3.5rem);
    line-height: 1.1;
    font-weight: var(--font-weight-7);
    margin-bottom: var(--size-5);
    color: var(--text-1);
  }

  .case-study__lede {
    font-size: clamp(1rem, 2vw, 1.25rem);
    color: var(--text-2);
    margin-bottom: var(--size-6);
    max-width: 65ch;
    line-height: 1.6;
  }

  /* Hero Image */
  .hero-image {
    margin-top: var(--size-6);
    border-radius: var(--radius-3);
    overflow: hidden;
  }

  .hero-image--contained {
    max-width: 100%;
  }

  .hero-image--full-bleed {
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    border-radius: 0;
  }

  .hero-image--devices {
    display: flex;
    gap: var(--size-4);
    justify-content: center;
    align-items: flex-end;
  }

  .hero-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Content body */
  .case-study__body {
    padding-block: clamp(3rem, 8vh, 6rem);
  }

  .case-study__body :global(h2) {
    font-size: var(--font-size-4);
    margin-top: var(--size-8);
    margin-bottom: var(--size-4);
    color: var(--text-1);
    line-height: var(--font-lineheight-2);
  }

  .case-study__body :global(h3) {
    font-size: var(--font-size-3);
    margin-top: var(--size-6);
    margin-bottom: var(--size-3);
    color: var(--text-1);
    line-height: var(--font-lineheight-2);
  }

  .case-study__body :global(h4) {
    font-size: var(--font-size-2);
    margin-top: var(--size-5);
    margin-bottom: var(--size-3);
    color: var(--text-2);
    line-height: var(--font-lineheight-2);
  }

  .case-study__body :global(p) {
    margin-bottom: var(--size-4);
    color: var(--text-2);
    line-height: var(--font-lineheight-4);
    max-width: 70ch;
  }

  .case-study__body :global(ul),
  .case-study__body :global(ol) {
    margin-bottom: var(--size-4);
    padding-left: var(--size-5);
    color: var(--text-2);
  }

  .case-study__body :global(li) {
    margin-bottom: var(--size-2);
    line-height: var(--font-lineheight-4);
  }

  .case-study__body :global(blockquote) {
    border-left: 3px solid var(--brand);
    padding-left: var(--size-5);
    margin-block: var(--size-6);
    font-style: italic;
    color: var(--text-2);
  }

  .case-study__body :global(code) {
    font-family: var(--font-mono);
    font-size: var(--font-size-0);
    background: var(--surface-2);
    padding: var(--size-1) var(--size-2);
    border-radius: var(--radius-1);
  }

  .case-study__body :global(pre) {
    background: var(--surface-2);
    padding: var(--size-4);
    border-radius: var(--radius-2);
    overflow-x: auto;
    margin-block: var(--size-6);
  }

  .case-study__body :global(pre code) {
    background: none;
    padding: 0;
  }

  .case-study__links {
    padding-block: var(--size-8);
    background: var(--surface-1);
    border-top: 1px solid var(--surface-3);
  }

  .case-study__links h2 {
    font-size: var(--font-size-3);
    margin-bottom: var(--size-4);
    color: var(--text-1);
  }

  .links-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--size-3);
  }

  .links-list a {
    display: inline-flex;
    align-items: center;
    gap: var(--size-2);
    color: var(--brand);
    text-decoration: none;
    font-weight: var(--font-weight-5);
    transition: transform 0.2s ease;
  }

  .links-list a:hover {
    transform: translateX(4px);
  }

  .links-list a i {
    font-size: var(--font-size-0);
  }

  .case-study__links {
    padding-block: 3rem;
    background: var(--surface-1);
    border-top: 1px solid var(--surface-3);
  }

  @media (min-width: 1024px) {
    .case-study__links {
      padding-block: 5rem;
    }
  }

  .case-study__links h2 {
    font-size: var(--font-size-3);
    margin-bottom: var(--size-6);
    color: var(--text-1);
  }

  .links-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--size-4);
  }

  .links-list a {
    display: inline-flex;
    align-items: center;
    gap: var(--size-2);
    color: var(--brand);
    text-decoration: none;
    font-weight: var(--font-weight-5);
    transition: transform 0.2s ease;
  }

  .links-list a:hover {
    transform: translateX(4px);
  }

  .links-list a i {
    font-size: var(--font-size-0);
  }

  .case-study__footer {
    padding-block: 3rem;
    border-top: 1px solid var(--surface-3);
  }

  @media (min-width: 1024px) {
    .case-study__footer {
      padding-block: 5rem;
    }
  }
</style>
