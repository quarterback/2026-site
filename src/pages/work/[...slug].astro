---
import { getCollection } from 'astro:content';
import Base from '../../layouts/Base.astro';
import CaseStudyImage from '../../components/CaseStudyImage.astro';
import CaseStudyImagePair from '../../components/CaseStudyImagePair.astro';

export async function getStaticPaths() {
  const work = await getCollection('work', ({ data }) => !data.draft);
  return work.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();
const {
  title,
  type,
  lede,
  metadata = {},
  links = [],
  tags = [],
} = entry.data;

// Build metadata line from available fields
const metadataItems = [
  metadata.dates,
  metadata.location,
  metadata.role,
  metadata.scale,
  metadata.status,
].filter(Boolean);
---

<Base title={`${title} â€” Ron Bronson`}>
  <article class="case-study">
    <header class="case-study__header">
      <div class="container">
        <a href="/#work" class="back-link">&larr; Back to work</a>

        <div class="case-study__type-badge">
          {type}
        </div>

        <h1>{title}</h1>

        <p class="case-study__lede">{lede}</p>

        {metadataItems.length > 0 && (
          <div class="case-study__metadata">
            {metadataItems.map((item, index) => (
              <>
                <span>{item}</span>
                {index < metadataItems.length - 1 && <span class="separator">|</span>}
              </>
            ))}
          </div>
        )}
      </div>
    </header>

    <div class="case-study__body">
      <div class="container container--narrow">
        <Content components={{ 'astro-image': CaseStudyImage, 'astro-image-pair': CaseStudyImagePair }} />
      </div>
    </div>

    {links.length > 0 && (
      <section class="case-study__links">
        <div class="container container--narrow">
          <h2>Links</h2>
          <ul class="links-list">
            {links.map(link => (
              <li>
                <a href={link.url} target="_blank" rel="noopener noreferrer">
                  {link.label}
                  <i class="fas fa-external-link-alt"></i>
                </a>
              </li>
            ))}
          </ul>
        </div>
      </section>
    )}

    <footer class="case-study__footer container">
      <a href="/#work" class="back-link">&larr; Back to all work</a>
    </footer>
  </article>
</Base>

<style>
  .case-study__header {
    padding-block: var(--size-8) var(--size-7);
    border-bottom: 1px solid var(--surface-3);
  }

  .back-link {
    display: inline-block;
    font-size: var(--font-size-0);
    color: var(--text-3);
    margin-bottom: var(--size-4);
    text-decoration: none;
  }

  .back-link:hover {
    color: var(--brand);
  }

  .case-study__type-badge {
    display: inline-block;
    font-family: var(--font-mono);
    font-size: var(--font-size-0);
    color: var(--brand);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--size-3);
  }

  .case-study__header h1 {
    margin-bottom: var(--size-4);
    font-size: var(--font-size-6);
    line-height: var(--font-lineheight-1);
  }

  .case-study__lede {
    font-size: var(--font-size-3);
    color: var(--text-2);
    margin-bottom: var(--size-4);
    max-width: 65ch;
    line-height: var(--font-lineheight-3);
    font-weight: var(--font-weight-5);
  }

  .case-study__metadata {
    display: flex;
    gap: var(--size-3);
    flex-wrap: wrap;
    font-family: var(--font-mono);
    font-size: var(--font-size-0);
    color: var(--text-3);
  }

  .case-study__metadata .separator {
    color: var(--surface-3);
  }

  .case-study__body {
    padding-block: var(--size-8);
  }

  .case-study__body :global(h2) {
    font-size: var(--font-size-4);
    margin-top: var(--size-8);
    margin-bottom: var(--size-4);
    color: var(--text-1);
    line-height: var(--font-lineheight-2);
  }

  .case-study__body :global(h3) {
    font-size: var(--font-size-3);
    margin-top: var(--size-6);
    margin-bottom: var(--size-3);
    color: var(--text-1);
    line-height: var(--font-lineheight-2);
  }

  .case-study__body :global(h4) {
    font-size: var(--font-size-2);
    margin-top: var(--size-5);
    margin-bottom: var(--size-3);
    color: var(--text-2);
    line-height: var(--font-lineheight-2);
  }

  .case-study__body :global(p) {
    margin-bottom: var(--size-4);
    color: var(--text-2);
    line-height: var(--font-lineheight-4);
    max-width: 70ch;
  }

  .case-study__body :global(ul),
  .case-study__body :global(ol) {
    margin-bottom: var(--size-4);
    padding-left: var(--size-5);
    color: var(--text-2);
  }

  .case-study__body :global(li) {
    margin-bottom: var(--size-2);
    line-height: var(--font-lineheight-4);
  }

  .case-study__body :global(blockquote) {
    border-left: 3px solid var(--brand);
    padding-left: var(--size-5);
    margin-block: var(--size-6);
    font-style: italic;
    color: var(--text-2);
  }

  .case-study__body :global(code) {
    font-family: var(--font-mono);
    font-size: var(--font-size-0);
    background: var(--surface-2);
    padding: var(--size-1) var(--size-2);
    border-radius: var(--radius-1);
  }

  .case-study__body :global(pre) {
    background: var(--surface-2);
    padding: var(--size-4);
    border-radius: var(--radius-2);
    overflow-x: auto;
    margin-block: var(--size-6);
  }

  .case-study__body :global(pre code) {
    background: none;
    padding: 0;
  }

  .case-study__links {
    padding-block: var(--size-8);
    background: var(--surface-1);
    border-top: 1px solid var(--surface-3);
  }

  .case-study__links h2 {
    font-size: var(--font-size-3);
    margin-bottom: var(--size-4);
    color: var(--text-1);
  }

  .links-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--size-3);
  }

  .links-list a {
    display: inline-flex;
    align-items: center;
    gap: var(--size-2);
    color: var(--brand);
    text-decoration: none;
    font-weight: var(--font-weight-5);
    transition: transform 0.2s ease;
  }

  .links-list a:hover {
    transform: translateX(4px);
  }

  .links-list a i {
    font-size: var(--font-size-0);
  }

  .case-study__footer {
    padding-block: var(--size-6);
    border-top: 1px solid var(--surface-3);
  }
</style>
